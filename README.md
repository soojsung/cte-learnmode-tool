# CTE Tool

CTE Tool is a PowerShell utility for analysing CipherTrust Transparent Encryption (CTE) agent logs on Windows and providing detailed information about users and processes that have accessed guarded resources. The tool specifically focuses on LEARN MODE logs, helping administrators determine access patterns before applying enforcement policies.

## Overview

This tool helps security administrators analyse access to resources protected by CTE. It parses log files generated by the agent and organizes access information by guardpoint folders, showing:

- Which users accessed each guardpoint
- What processes were used 
- Which specific resources were accessed
- What types of actions were performed (reading, writing, etc.)

## Features

- Automatic processing of all CTE agent log files in a directory
- Guardpoint-centric organization for easier policy development
- Comprehensive breakdown of user, process, and resource access
- Classification of access actions (reading, writing, creating, etc.)
- Support for multiple log files with aggregated results
- Intelligent guardpoint detection for SQL Server and other applications
- Proper handling of domain users and groups with clean display format
- Special case handling for system accounts and service accounts
- Categorized group membership display (Security Groups, Domain Groups, etc.)
- Accurate statistics for each guardpoint and overall summary
- Clean formatting of usernames, domain names, and group names

## Requirements

- Windows operating system
- PowerShell 5.0 or newer
- Access to CTE agent log files with LEARN MODE entries

## Usage

### Basic Usage

Run the script without parameters to process the default log directory:

```powershell
.\cte-tool.ps1
```

This will analyse all matching log files (`vorvmd*.log*`) in the default directory `C:\ProgramData\Vormetric\DataSecurityExpert\agent\log`.

### Specifying a Custom Log Directory

To analyse logs in a different directory:

```powershell
.\cte-tool.ps1 -logpath "C:\path\to\log\directory"
```

> **Note:** The `-logpath` parameter must specify a directory containing log files, not a specific file.

## Output Format

The tool organizes output by detected guardpoint folders:

### Guardpoint Information

For each guardpoint, the tool displays:

```
=== GUARDPOINT: C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA (368 accesses) ===

  Statistics:
    - Users: 2
    - Processes: 3
    - Resources: 12
    - Access Events: 368

  Users:
    - NT SERVICE\MSSQLSERVER (37 accesses)
      Group Memberships:
        Mandatory Labels:
          Domain: Mandatory Label
            - High Mandatory Level
            - MSSQLSERVER\High Mandatory Level
          General Groups:
            - Domain: Mandatory Label
        Server Groups:
          Domain: DOMAINSERVER
            - Certificate Service DCOM Access
            - Pre-Windows 2000 Compatible Access
          Domain: localhost
            - Certificate Service DCOM Access
            - Pre-Windows 2000 Compatible Access
        Security Groups:
          Domain: DOMAINSERVER
            - Users
          Domain: localhost
            - Users
          Domain: localhost\NT SERVICE
            - Users
    - NT AUTHORITY\SYSTEM (2 accesses)

  Processes:
    - sqlservr.exe (37 accesses)
      Path: C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\Binn\sqlservr.exe
    - MsMpEng.exe (1 accesses)
      Path: C:\ProgramData\Microsoft\Windows Defender\platform\4.18.2105.3-0\MsMpEng.exe

  Resources:
    - C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\tempdb.mdf (4 accesses)
      Common action: reading meta
    - C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\ (2 accesses)
      Common action: listing
```

### Group Membership Display

The tool categorizes group memberships for better readability and organization:

- **Security Groups**: Administrative and user-related groups (Administrators, Users, Domain Admins, etc.)
- **Domain Groups**: Groups associated with specific domains
- **Mandatory Labels**: Security contexts and integrity levels
- **Server Groups**: Groups specific to server roles
- **Other Groups**: Groups that don't fit into the categories above

Each group name is properly formatted to remove extraneous backslashes and clearly shows domain relationships where applicable. Groups are further organized by domain to provide a hierarchical view that makes it easier to understand user permissions.

### Summary

The tool provides an overall summary of activity:

```
=== SUMMARY ===
  Total Users: 4
  Total Processes: 5
  Total Resources: 18
  Detected GuardPoints: 3
  Total Access Events: 414
```

## How It Works

1. The tool finds all CTE log files in the specified directory
2. It extracts information from LEARN MODE log entries only
3. The script identifies guardpoint folders from resource paths with intelligent detection
4. User and group information is parsed and categorized
5. Access information is grouped by guardpoint with detailed statistics
6. Results are displayed in a structured, readable format

## Advanced Features

### Intelligent Guardpoint Detection

The tool automatically identifies guardpoint folders based on common patterns:
- SQL Server data and application paths
- Standard directory structures
- System paths with access patterns

### User and Group Handling

- Proper formatting of usernames as "DOMAIN\USER" with consistent display
- Special handling for system accounts like "NT AUTHORITY\SYSTEM"
- Intelligent cleaning of backslashes in domain and group names
- Removal of leading backslashes and normalization of multiple backslashes
- Categorization of group memberships by type for better organization
- Filtering of meaningless or empty group entries
- Accurate user count statistics for all guardpoints

## Troubleshooting

### Log Files Not Found

If no log files are found, verify you're pointing to the correct directory containing `vorvmd*.log*` files.

### No Data Displayed

If the tool runs but shows no data, verify:
- The log files contain CTE agent logs
- There are LEARN MODE entries in the logs (not just AUDIT entries)
- The files are readable by your user account

### Access Permission Issues

If you encounter access permission errors:
- Try running as Administrator
- Check that the log files aren't locked by another process
- Verify read permissions on the log directory

## Credits

This tool is based on modules from the Thales CipherTrust Transparent Encryption GitHub repository:
https://github.com/thalescpl-io/CipherTrust_Transparent_Encryption/tree/main/tools/learn-mode-policy-builder

## Version

3.0 
